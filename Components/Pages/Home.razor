@page "/"
@using Nsharp.Models
@using Nsharp.Services
@inject NetworkScanner NetworkScanner
@inject PdfReportService PdfService
@inject AiAnalysisService AiService
@inject SettingsService SettingsService
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Nsharp - Scanner Réseau</PageTitle>

@if (!string.IsNullOrEmpty(initError))
{
    <div class="alert alert-danger m-4">
        <strong>Erreur critique au chargement :</strong> @initError
        <br/>
        <small>Vérifiez les logs console du serveur pour plus de détails.</small>
    </div>
}
else
{
<div class="scanner-container">
    <div class="config-panel">
        <h3 class="section-title">Configuration du scan</h3>
        
        <div class="form-group">
            <label>Cible (IP ou nom de domaine)</label>
            <input @bind="targetAddress" class="form-input" placeholder="192.168.1.1" />
        </div>
        
        <div class="form-group">
            <label>Ports à scanner</label>
            <input @bind="portsToScan" class="form-input" placeholder="22,80,443 ou 1-1000" />
            <small>Laissez vide pour scanner les ports communs</small>
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" @bind="aggressiveMode" />
                Mode agressif (détection OS)
            </label>
        </div>
        
        <button @onclick="StartScan" disabled="@isScanning" class="btn btn-primary">
            @if (isScanning)
            {
                <span class="spinner-small"></span>
                <span>@scanningStatus</span>
            }
            else
            {
                <span>Démarrer le scan</span>
            }
        </button>
        
        @if (scanResults.Count > 0 && !isScanning)
        {
            <button @onclick="ExportPdf" class="btn btn-secondary">
                Exporter PDF
            </button>
        }
        
        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <div class="status-message @statusClass">
                @if (isScanning && statusClass == "info")
                {
                   <span class="spinner-small-blue"></span>
                }
                @statusMessage
            </div>
        }
        
        @if (!string.IsNullOrEmpty(osDetection))
        {
            <div class="os-detection">
                <strong>Système détecté:</strong> @osDetection
            </div>
        }
    </div>
    
    <div class="results-panel">
        <h3 class="section-title">Résultats du scan</h3>
        
        @if (scanResults.Count == 0 && !isScanning)
        {
            <div class="no-results">
                <p>Aucun résultat pour le moment</p>
                <p><small>Configurez un scan et cliquez sur "Démarrer"</small></p>
            </div>
        }
        else if (isScanning && scanResults.Count == 0)
        {
            <div class="loading">
                <div class="spinner"></div>
                <p>Scan en cours, veuillez patienter...</p>
            </div>
        }
        else
        {
            <div class="summary">
                <strong>@scanResults.Count port(s) ouvert(s) détecté(s)</strong>
                @if (isScanning) {
                    <span class="scanning-badge">Analyse IA en cours...</span>
                }
            </div>
            
            <div class="results-list">
                @foreach (var result in scanResults)
                {
                    <div class="result-card">
                        <div class="result-header">
                            <div class="port-info">
                                <span class="port-number">Port @result.Port</span>
                                <span class="service-name">@result.Service</span>
                            </div>
                            <span class="status-badge">@result.Status</span>
                        </div>
                        
                        <div class="result-body">
                            <div class="info-grid">
                                <div class="info-section">
                                    <strong>Protocole</strong>
                                    <p>@result.Protocol</p>
                                </div>
                                <div class="info-section">
                                    <strong>État</strong>
                                    <p>@result.StateDescription</p>
                                </div>
                            </div>
                            
                            <div class="info-section details-section">
                                <strong>Détails Techniques</strong>
                                <div class="details-content">
                                    @result.Details
                                </div>
                            </div>
                            
                            @if (!string.IsNullOrEmpty(result.AiExplanation))
                            {
                                <div class="info-section ai-section">
                                    <strong>Audit & exploitation (IA)</strong>
                                    <div class="ai-text">
                                        @((MarkupString)result.AiExplanation.Replace("\n", "<br/>"))
                                    </div>
                                </div>
                            }
                            else if (isScanning && AiService.HasApiKey())
                            {
                                <div class="info-section ai-loading">
                                    <span class="spinner-tiny"></span> Analyse IA en cours...
                                </div>
                            }
                            else if (!AiService.HasApiKey() && !isScanning)
                            {
                                 <div class="info-section advice-section">
                                    <strong>Note</strong>
                                    <p>Configurez votre clé API dans les <a href="settings">Préférences</a> pour activer l'analyse IA des vulnérabilités.</p>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>
}

@code {
    private string targetAddress = "";
    private string portsToScan = "";
    private bool aggressiveMode = false;
    private bool isScanning = false;
    private string scanningStatus = "Scan en cours...";
    private string statusMessage = "";
    private string statusClass = "";
    private string osDetection = "";
    private string initError = "";
    private List<ScanResult> scanResults = new();

    protected override void OnInitialized()
    {
        try
        {
            // Vérification de base pour s'assurer que les services sont injectés
            if (SettingsService == null || AiService == null || NetworkScanner == null)
            {
                throw new Exception("Un ou plusieurs services n'ont pas pu être injectés.");
            }
        }
        catch (Exception ex)
        {
            initError = ex.Message;
            Console.WriteLine($"Critical Error in Home.razor: {ex}");
        }
    }

    private async Task StartScan()
    {
        if (string.IsNullOrWhiteSpace(targetAddress))
        {
            statusMessage = "Veuillez saisir une adresse IP ou nom de domaine";
            statusClass = "error";
            return;
        }

        isScanning = true;
        scanningStatus = "Scan en cours...";
        statusMessage = "Scan en cours...";
        statusClass = "info";
        scanResults.Clear();
        osDetection = "";

        try
        {
            // Étape 1 : Scan Réseau
            var response = await NetworkScanner.ScanAsync(
                targetAddress,
                portsToScan,
                aggressiveMode
            );

            scanResults = response.Results;
            osDetection = response.OsDetection ?? "";

            // Étape 2 : Analyse IA si des ports sont trouvés et clé API présente
            if (scanResults.Count > 0)
            {
                if (AiService.HasApiKey())
                {
                    scanningStatus = "Analyse IA...";
                    statusMessage = "Analyse des services par l'IA...";
                    StateHasChanged(); 
                    
                    await AiService.EnrichScanResultsAsync(scanResults);
                    
                    statusMessage = $"Scan terminé avec succès - {scanResults.Count} port(s) ouvert(s) + Analyse IA";
                    statusClass = "success";
                }
                else
                {
                    statusMessage = $"Scan terminé - {scanResults.Count} port(s) ouvert(s). Configurez l'IA pour plus de détails.";
                    statusClass = "success";
                }
            }
            else
            {
                statusMessage = "Scan terminé - Aucun port ouvert détecté";
                statusClass = "warning";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Erreur lors du scan: {ex.Message}";
            statusClass = "error";
        }
        finally
        {
            isScanning = false;
        }
    }

    private async Task ExportPdf()
    {
        try
        {
            statusMessage = "Génération du PDF...";
            statusClass = "info";

            var pdfPath = await PdfService.GenerateReportAsync(scanResults, targetAddress, osDetection);
            var fileBytes = await File.ReadAllBytesAsync(pdfPath);
            var fileName = Path.GetFileName(pdfPath);

            await JS.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileBytes));

            statusMessage = "PDF téléchargé avec succès";
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = $"Erreur lors de l'export: {ex.Message}";
            statusClass = "error";
        }
    }
}
